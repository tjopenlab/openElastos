<!--==========================================================================-->
<!-- Copyright (c) 2000-2004,  Elastos, Inc.  All Rights Reserved.-->
<!--==========================================================================-->

<html>

<head>
    <title>Interface Smart Pointer</title>
    <meta http-equiv="Content-Type" content="text/html; charset=gb2312">
    <script src="/xsl/docstyles.js"></script>

</head>

<body>
    <h2>Interface Smart Pointer</h2>
        <p>In MS&nbsp;COM, the user directly obtains COM object interface pointer, then visit the interface method defined by this interface through this interface pointer.</p>
        <p>In CAR, interface smart pointer is implemented, user visit methods defined by this interface through interface smart pointer. From this point of view, interface smart pointer is an encapsulation of the interface. Here we describe in details how interface smart pointer is implemented and provide a interface smart pointer implementation method.</p>
        <p>In C++ language, interface smart pointer is defined as class, this class has only one member variable, which is the interface pointer that actually points to the object interface. As illustrated in the following image: </p>
        <center><img src="images/inter.jpg"></center>
        <p>In the image IARef represents interface smart pointer corresponding to interface IA, component object implements interface IA.</p>
        <p>Interface smart pointer implements all methods of this interface. The implementation of these interface methods is through member variable invocation of component object. As shown in the following image: </p>
        <center><img src="images/transfer.jpg"></center>
        <p>CAR interface smart pointer implements intelligent management of reference count, so there is no need for the users to manage the reference count themselves.</p>
        <p>First, two interface smart pointer class corresponding to IUnknown interface are defined, InterfaceRefArg and InterfaceRef. InterfaceRef inherits InterfaceRefArg. (see MSDN for details about IUnknown interface) A member variable IUnknown&nbsp;*&nbsp;&amp;&amp;&amp;&amp;m_pIface is defined in InterfaceRefArg class. All other interface smart pointers inherit this class, so all interface smart pointers has this member variable.</p>
        <p>Just like all the interface inherit IUnknown, all the interface smart pointer inherit InterfaceRefArg. Use IButton as an example, their inheritance relationship is shown as the following image: </p>
        <center><img src="images/inherit.jpg"></center>
        <p>Component object that implement the interface can be created through interface smart pointer, member variable of this smart pointer is made to point to this newly created component object.</p>
        <p>This article contains the following content: </p>
    <ul>
        <li><a class="style1" href="#form">Interface smart pointer representation</a>
        <li><a class="style1" href="#create">Creation of interface smart pointer</a>
        <li><a class="style1" href="#validity">Interface smart pointer validation</a>
        <li><a class="style1" href="#use">How to use interface smart pointer?</a>
    </ul>
    <h4><a name="form"></a>Representation of interface smart pointer</h4>
        <p>Representation of interface smart pointer: IxxxRef, of which Ixxx represents interface name.</p>
        <p>The following uses Hello component as an example, introduces how to create and use interface smart pointer. First please see the content of helloworld.car file: </p>
        <pre class="code">
[
    uuid(29899803-5da2-45f0-a4b7-387b76590abe),
    uunm(http://www.koretide.com/car/helloworld.dll)
]
component Hello
{
    //interface IHello
    [uuid(225c5629-5cd8-403a-97d9-204ffda2976d)]
    interface IHello {
        ECODE SayHello();
    }

    //interface IWorld
    [uuid(ba85f03f-7f55-4595-9137-cee4ea43b404)]
    interface IWorld {
        ECODE SayWorld();
    }

    //class CHello
    [uuid(3b1e3a47-9a78-4466-ab11-ad8512761e0d)]
    class CHello {
        interface IHello;
    }

    //class CHelloWorld
    [uuid(1627061a-36b9-4dcb-b9af-5967db085d17)]
    class CHelloWorld {
        interface IHello;
        interface IWorld;
    }
}
</pre>
        <p>Two interfaces are defined in helloworld.car file, IHello and IWorld. In client program, import is used to use Hello component, as the following: </p>
        <pre class="code">
#import &lt;helloworld.dll&gt;
</pre>
        <p>Client program has these two interface smart pointer types: IHelloRef and IWorldRef.</p>

    <h4><a name="create"></a>Creation of interface smart pointer</h4>
        <p>Legal interface smart pointer can be created through the following methods: </p>
        <p><b>Method one: </b>Creates a interface smart pointer, invokes <b>Instantiate</b> method to create a specified class object and make interface smart pointer points to corresponding interface in this object.</p>
        <ul>
            <li>When the user needs to specify the relative location of created object to client, corresponding parameter needs to be set while invoking <b>Instantiate</b> method. For example: </p>
                <pre class="code">
IHelloRef iHello;   //creates interface smart pointer iHello
//instantiate class CHello, interface smart pointer iHello points to the IHello interface in this object
ECODE ec = iHello.<b>Instantiate(CLSID_CHello, CTX_SAME_DOMAIN)</b>;
if (FAILED(ec)) {   //validate the smart pointer through return value
    printf("iHello initialize failed\n");
    return 1;
}
</pre>
            <p><b><font color="red">Note: </b>Since the same interface can be in multiple classes, class identifier CLSID needs to be specified when invoking <b>Instantiate</b> method to create interface smart pointer, the parameter representation is CLSID_classname .</font></p>
            <p>In the example: The first parameter <i>CLSID_CHello</i> of <b>Instantiate</b> method indicates that it generates a CHello class object. If this parameter is replaced with CLSID_CHelloWorld then it means that a CHelloWorld class object is generated.</p>
            <p>The second parameter <i>CTX_SAME_DOMAIN</i> specifies relative location of object with client, for possible value of the second parameter and meaning of each value please see <a class="style1" href="code_running_env.htm">executable code run-time environment (context)</a>.</p>

            <li>When the user does not care the relative location between created object and client, the second parameter is not needed when invoking <b>Instantiate</b> method. For example: </p>
                <pre class="code">
IHelloRef iHello;   //creates interface smart pointer iHello
//instantiate class CHello, interface smart pointer iHello points to IHello interface in this object
ECODE ec = iHello.<b>Instantiate(CLSID_CHello)</b>;
if (FAILED(ec)) {   //validate smart pointer using return value
    printf("iHello initialize failed\n");
    return 1;
}
</pre>
            <p>In the example, there is no second parameter when invoking <b>Instantiate</b> method, the system default is one of the three values CTX_SAME_DOMAIN, CTX_DIFF_DOMAIN and CTX_DIFF_PROCESS, the relative location of created object and the client is determined by priority.</p>
        </ul>

        <p>The following two methods can also create legal interface smart pointer. This way you can initialize or assign new interface smart pointer using legal interface smart pointer. However there is a requirement when using these two methods: <b>Object pointed to by this legal interface smart pointer must provide corresponding interface of newly created interface smart pointer.</b></p>

        <p><b>Method two: </b>Use legal interface smart pointer to initialize newly created interface smart pointer. For example: </p>
        <pre class="code">
IHelloRef iHello;
ECODE ec = iHello.Instantiate(CLSID_CHelloWorld);
if (FAILED(ec)) {   //validate smart pointer iHello using return value
    printf("iHello initialize failed\n");
    return 1;
}

//initializes newly created interface smart pointer iWorld using interface smart pointer iHello
<b>IWorldRef iWorld = i2i(iHello);</b>
if (!iWorld.IsValid()) { //validate smart pointer iWorld using IsValid() method
    assert(0 && "Can't create cHello");
    return 1;
}
</pre>
        <p>In the example, two interfaces IHello and IWorld are implemented in class CHelloWorld. Invokes <b>i2i</b> method to convert iHello interface smart pointer to IWorldRef type value, initialize iWorld interface smart pointer using return result, the requirement is that iHello must be leagal interface smart pointer. iHello needs to be validated. If interface smart pointer iHello is successfully converted, then interface smart pointer iWorld points to IWorld interface in class CHelloWorld object.</p>
        <p><b>Remarks: </b>Parameter and return value of <b>i2i</b> method must interface smart pointer of the same class. Operation executed by function <b>i2i</b> converts smart pointer type of one interface to smart pointer type of any one interface of the same class.</p>

        <p><b>Method three: </b>Assign value to newly created smart pointer using legal interface smart pointer: </p>
        <pre class="code">
IHelloRef iHello;
ECODE ec = iHello.Instantiate(CLSID_CHelloWorld);
if (FAILED(ec)) {   //validates smart pointer iHello using return value
    printf("iHello initialize failed\n");
    return 1;
}

IWorldRef iWorld;
//assign value to newly created interface smart pointer iWorld using interface smart pointer iHello
<b>iWorld = i2i(iHello);</b>
if (!iWorld.IsValid()) {    //validate smart pointer iWorld using IsValid() method
    assert(0 && "Can't create cHello");
    return 1;
}
</pre>
        <p>In the example, there are two interfaces IHello and IWorld in class CHelloWorld. We assign value to interface smart pointer iWorld using interface smart pointer iHello, but iHello must be legal smart pointer. So we must validate iHello. If created interface smart pointer iWorld is legal, it points to IWorld interface in class CHelloWorld object.</p>

    <h4><a name="validity"></a>Validation of interface smart pointer</h4>
        <p>The user must validate the interface smart pointer after creating the smart pointer, only valid interface smart pointer is legal interface smart pointer. The method is as the following: </p>
        <p><b>Method one: </b>Checks the return value, for example: </p>
        <pre class="code">
бнбн
IHelloRef iHello;
<b>ECODE ec = iHello.Instantiate(CLSID_CHelloWorld);
if (FAILED(ec)) {   //validate interface smart pointer iHello using return value
    printf("iHello initialize failed\n");
    return 1;
}</b>
бнбн
</pre>

        <p><b>Method two: </b>Checks using <b>IsValid</b> method, for example: </p>
        <pre class="code">
бнбн
IHelloRef iHello;
ECODE ec = iHello.Instantiate(CLSID_CHelloWorld);
if (FAILED(ec)) {
    printf("iHello initialize failed\n");
    return 1;
}

IWorldRef iWorld = i2i(iHello);
//validate interface smart pointer iWorld using IsValid() method
<b>if (!iWorld.IsValid()) {
    assert(0 && "Can't create cHello");
    return 1;
}</b>
бнбн
</pre>
        <p><b>Remarks: </b>When initializing smart pointer using <b>Instantiate()</b> method, it is recommended to validate smart pointer using return value. Through return value we can obtain more detailed information. For example: Interface not found, not enough memory etc. <b>IsValid()</b> method only checks if the smart pointer is valid, it cannot obtain specific error information.</p>

    <h4><a name="use"></a>How to use interface smart pointer?</h4>
        <p>Interface smart pointer uses "." dot operator to invoke method in corresponding interface. For example: </p>
        <pre class="code">
//invoke corresponding interface method using interface smart pointer
IHelloRef iHello;
ECODE ec;
ec = iHello.Instantiate(CLSID_CHello);
if (FAILED(ec)) {   //validate smart pointer using return value
    printf("iHello initialize failed\n");
    return 1;
}

IWorldRef iWorld;
ec = iWorld.Instantiate(CLSID_CHelloWorld);
if (FAILED(ec)) {   //validate smart pointer using return value
    printf("iWorld initialize failed\n");
    return 1;
}

//invokes method SayHello() in the IHello interface in class CHello object through interface smart pointer iHello
<b>iHello.SayHello();</b>
//invokes SayWorld() method in the IWorld interface in class CHelloWorld object through interface smart pointer iWorld
<b>iWorld.SayWorld();</b>
</pre>
        <p><b><font color=red>Note: </b>Only methods in the interface that interface smart pointer points to can be invoked.</font></p>


<script>footer("english")</script>
</body>
</html>